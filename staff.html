<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô - Smart ‡∏≠‡∏ö‡∏ï.‡∏´‡∏ô‡∏≠‡∏á‡∏ô‡∏≤‡∏Ñ‡∏≥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; }
        .pending-border { border-left: 6px solid #ef4444; }
    </style>
</head>
<body class="max-w-md mx-auto pb-10">

    <div class="bg-gray-800 p-6 text-white text-center shadow-lg">
        <h1 class="text-xl font-bold">üõ†Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô</h1>
        <p class="text-xs opacity-60">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á ‡∏≠‡∏ö‡∏ï.</p>
    </div>

    <div id="jobList" class="p-4 space-y-4">
        <p class="text-center text-gray-500 mt-10">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô...</p>
    </div>

    <script>
        // --- ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‚ö†Ô∏è ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï URL ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö) ---
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzIdilhESvKPounPWBHhUpSV-cDvXALUAwAql9Zq3J--lxv-_llL7Fl4SfzD0-U0P10/exec"; 
        const IMGBB_API_KEY = "2a80595118a7dc36b3ebda7a006fef3b";
        // ---------------------------------------------

        async function loadJobs() {
            try {
                const response = await fetch(WEB_APP_URL);
                const data = await response.json();
                const jobList = document.getElementById('jobList');
                jobList.innerHTML = "";

                // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£"
                const pendingJobs = data.filter(job => job.status === "‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£");

                if (pendingJobs.length === 0) {
                    jobList.innerHTML = '<div class="text-center p-10 text-gray-400">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>';
                    return;
                }

                pendingJobs.forEach(job => {
                    const card = `
                        <div class="bg-white rounded-xl shadow-md p-4 pending-border">
                            <div class="flex justify-between items-start mb-2">
                                <span class="bg-red-100 text-red-700 text-xs px-2 py-1 rounded font-bold">${job.type}</span>
                                <span class="text-gray-400 text-[10px]">${new Date(job.timestamp).toLocaleString('th-TH')}</span>
                            </div>
                            <img src="${job.image}" class="w-full h-40 object-cover rounded-lg mb-3">
                            <h3 class="font-bold text-gray-800">${job.detail}</h3>
                            <p class="text-xs text-gray-500 mt-1">‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á: ${job.name}</p>
                            
                            <div class="mt-4 flex gap-2">
                                <a href="https://www.google.com/maps/search/?api=1&query=${job.lat},${job.lng}" target="_blank" class="flex-1 bg-blue-100 text-blue-700 text-center py-2 rounded-lg text-sm font-bold flex items-center justify-center">üìç ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>
                                <button onclick="closeJob('${job.jobId}')" class="flex-1 bg-green-600 text-white py-2 rounded-lg text-sm font-bold shadow-md hover:bg-green-700 transition">‚úÖ ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</button>
                            </div>
                        </div>
                    `;
                    jobList.innerHTML += card;
                });
            } catch (e) {
                document.getElementById('jobList').innerHTML = "<p class='text-center text-red-500'>‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>";
            }
        }

        async function closeJob(jobId) {
            // 1. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á (User) ‡∏°‡∏≤‡πÉ‡∏™‡πà Dropdown
            let userOptions = '<option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà...</option>';
            try {
                const res = await fetch(WEB_APP_URL + "?action=getUsers");
                const users = await res.json();
                users.forEach(u => {
                    userOptions += `<option value="${u}">${u}</option>`;
                });
            } catch (e) {
                userOptions = '<option value="">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà)</option>';
            }

            // 2. ‡πÅ‡∏™‡∏î‡∏á Popup ‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ + ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô + ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ
            const { value: formValues } = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô',
                html:
                    '<div class="text-left text-sm text-gray-600 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô:</div>' +
                    `<select id="staffName" class="swal2-input mb-3" style="width: 80%;">${userOptions}</select>` +
                    
                    '<div class="text-left text-sm text-gray-600 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô:</div>' +
                    '<input type="password" id="staffPass" class="swal2-input" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" style="width: 80%;">' +
                    
                    '<div class="text-left text-sm text-gray-600 mt-4 mb-1">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°:</div>' +
                    '<input type="file" id="imgAfter" accept="image/*" class="swal2-file" style="width: 80%;">',
                showCancelButton: true,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô',
                confirmButtonColor: '#28a745',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                preConfirm: () => {
                    const st = document.getElementById('staffName').value;
                    const pw = document.getElementById('staffPass').value;
                    const fi = document.getElementById('imgAfter').files[0];
                    
                    if (!st) { Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà'); return false; }
                    if (!pw) { Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'); return false; }
                    if (!fi) { Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°'); return false; }
                    
                    return { staff: st, pass: pw, file: fi };
                }
            });

            if (formValues) {
                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                try {
                    // 3. ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏õ ImgBB
                    let reader = new FileReader();
                    reader.readAsDataURL(formValues.file);
                    reader.onload = async () => {
                        let base64 = reader.result.split(',')[1];
                        let formData = new FormData();
                        formData.append("image", base64);
                        
                        let imgRes = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
                        let imgJson = await imgRes.json();
                        let finalImg = imgJson.data.url;

                        // 4. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Script (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô)
                        let payload = {
                            action: "close_job",
                            jobId: jobId,
                            staff: formValues.staff,
                            password: formValues.pass, // üö© ‡∏™‡πà‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ‡∏ï‡∏£‡∏ß‡∏à
                            image: finalImg
                        };

                        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                        
                        // ‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏ô‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î (‡πÄ‡∏û‡∏£‡∏≤‡∏∞ no-cors ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ß‡πà‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà)
                        // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡πÉ‡∏ô Apps Script ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                        setTimeout(() => {
                            Swal.fire('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '‡∏´‡∏≤‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô', 'success')
                            .then(() => loadJobs());
                        }, 2500);
                    };
                } catch (e) {
                    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
                }
            }
        }

        loadJobs();
    </script>
</body>
</html>


