<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏≤‡∏á - Smart ‡∏≠‡∏ö‡∏ï.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; }
        .pending-border { border-left: 6px solid #ef4444; }
    </style>
</head>
<body class="max-w-md mx-auto pb-10">

    <div class="bg-gray-800 p-6 text-white text-center shadow-lg">
        <h1 class="text-xl font-bold">üõ†Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°</h1>
        <p class="text-xs opacity-60">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≠‡∏á‡∏ä‡πà‡∏≤‡∏á ‡∏≠‡∏ö‡∏ï.</p>
    </div>

    <div id="jobList" class="p-4 space-y-4">
        <p class="text-center text-gray-500 mt-10">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏≤‡∏ô...</p>
    </div>

    <script>
        // --- ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ index.html) ---
        const WEB_APP_URL = "‡∏ß‡∏≤‡∏á_URL_‡∏à‡∏≤‡∏Å_Apps_Script_‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà"; 
        const IMGBB_API_KEY = "‡∏ß‡∏≤‡∏á_API_KEY_‡∏Ç‡∏≠‡∏á_ImgBB_‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà";
        // ---------------------------------------------

        async function loadJobs() {
            try {
                const response = await fetch(WEB_APP_URL);
                const data = await response.json();
                const jobList = document.getElementById('jobList');
                jobList.innerHTML = "";

                // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ "‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£"
                const pendingJobs = data.filter(job => job.status === "‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£");

                if (pendingJobs.length === 0) {
                    jobList.innerHTML = '<div class="text-center p-10 text-gray-400">‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>';
                    return;
                }

                pendingJobs.forEach(job => {
                    const card = `
                        <div class="bg-white rounded-xl shadow-md p-4 pending-border">
                            <div class="flex justify-between items-start mb-2">
                                <span class="bg-red-100 text-red-700 text-xs px-2 py-1 rounded font-bold">${job.type}</span>
                                <span class="text-gray-400 text-[10px]">${new Date(job.timestamp).toLocaleString('th-TH')}</span>
                            </div>
                            <img src="${job.image}" class="w-full h-40 object-cover rounded-lg mb-3">
                            <h3 class="font-bold text-gray-800">${job.detail}</h3>
                            <p class="text-xs text-gray-500 mt-1">‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á: ${job.name}</p>
                            
                            <div class="mt-4 flex gap-2">
                                <a href="https://www.google.com/maps?q=${job.lat},${job.lng}" target="_blank" class="flex-1 bg-blue-100 text-blue-700 text-center py-2 rounded-lg text-sm font-bold">üìç ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</a>
                                <button onclick="closeJob('${job.jobId}')" class="flex-1 bg-green-600 text-white py-2 rounded-lg text-sm font-bold shadow-md">‚úÖ ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô</button>
                            </div>
                        </div>
                    `;
                    jobList.innerHTML += card;
                });
            } catch (e) {
                document.getElementById('jobList').innerHTML = "<p class='text-center text-red-500'>‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ</p>";
            }
        }

        async function closeJob(jobId) {
            const { value: formValues } = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô',
                html:
                    '<input id="staffName" class="swal2-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏ã‡πà‡∏≠‡∏°">' +
                    '<p class="text-xs text-gray-400 mt-3 text-left px-8">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à:</p>' +
                    '<input type="file" id="imgAfter" accept="image/*" class="swal2-file">',
                showCancelButton: true,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô',
                preConfirm: () => {
                    return {
                        staff: document.getElementById('staffName').value,
                        file: document.getElementById('imgAfter').files[0]
                    }
                }
            });

            if (formValues) {
                if (!formValues.staff || !formValues.file) {
                    Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏Ñ‡∏£‡∏±‡∏ö', 'warning');
                    return;
                }

                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                try {
                    // 1. ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°‡πÑ‡∏õ ImgBB
                    let reader = new FileReader();
                    reader.readAsDataURL(formValues.file);
                    reader.onload = async () => {
                        let base64 = reader.result.split(',')[1];
                        let formData = new FormData();
                        formData.append("image", base64);
                        
                        let imgRes = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
                        let imgJson = await imgRes.json();
                        let finalImg = imgJson.data.url;

                        // 2. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Script ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô Sheet
                        let payload = {
                            action: "close_job",
                            jobId: jobId,
                            staff: formValues.staff,
                            image: finalImg
                        };

                        await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                        
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success').then(() => loadJobs());
                    };
                } catch (e) {
                    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏¥‡∏î‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ', 'error');
                }
            }
        }

        loadJobs();
    </script>
</body>
</html>
