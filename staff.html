<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏á‡∏≤‡∏ô - Smart ‡∏≠‡∏ö‡∏ï.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; }
        .status-wait { border-left: 6px solid #F1C40F; } /* ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á */
        .status-new { border-left: 6px solid #ef4444; }  /* ‡∏™‡∏µ‡πÅ‡∏î‡∏á */
    </style>
</head>
<body class="max-w-md mx-auto pb-20">

    <div class="bg-gray-800 p-6 text-white text-center shadow-lg sticky top-0 z-10">
        <h1 class="text-xl font-bold">üõ†Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏Ñ‡∏á‡∏Ñ‡πâ‡∏≤‡∏á</h1>
        <p class="text-xs opacity-60">‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</p>
    </div>

    <div id="jobList" class="p-4 space-y-4">
        <p class="text-center text-gray-500 mt-10">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <script>
        // ‚ö†Ô∏è ‡πÄ‡∏≠‡∏≤ URL ‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwhaYbM3A6SJq1ZATIFT0Y-wRSFQjeGDIeH6uJ9Ee-TaeII7_mSZqBGQ8g_FVv-KHjofQ/exec"; 
        const IMGBB_API_KEY = "2a80595118a7dc36b3ebda7a006fef3b";

        async function loadJobs() {
            try {
                const response = await fetch(WEB_APP_URL);
                const data = await response.json();
                const jobList = document.getElementById('jobList');
                jobList.innerHTML = "";

                // ‡∏Å‡∏£‡∏≠‡∏á‡∏á‡∏≤‡∏ô: ‡πÅ‡∏™‡∏î‡∏á‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à" ‡πÅ‡∏•‡∏∞ "‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï"
                const pendingJobs = data.filter(job => 
                    job.status !== "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" && job.status !== "‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö"
                );

                if (pendingJobs.length === 0) {
                    jobList.innerHTML = '<div class="text-center p-10 text-gray-400">‚úÖ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>';
                    return;
                }

                pendingJobs.forEach(job => {
                    let isNew = (job.status === "‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£");
                    let borderClass = isNew ? "status-new" : "status-wait";
                    let statusBadge = isNew 
                        ? `<span class="bg-red-100 text-red-700 text-xs px-2 py-1 rounded font-bold">üî• ‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</span>`
                        : `<span class="bg-yellow-100 text-yellow-700 text-xs px-2 py-1 rounded font-bold">‚è≥ ${job.status}</span>`;

                    const card = `
                        <div class="bg-white rounded-xl shadow-md p-4 ${borderClass} relative">
                            <div class="flex justify-between items-start mb-2">
                                <span class="text-gray-700 font-bold text-sm">${job.type}</span>
                                <span class="text-gray-400 text-[10px]">${new Date(job.timestamp).toLocaleString('th-TH')}</span>
                            </div>
                            <div class="mb-2">${statusBadge}</div>
                            
                            <img src="${job.image}" onclick="viewImage('${job.image}')" class="w-full h-40 object-cover rounded-lg mb-3 shadow-sm border cursor-pointer">
                            
                            <h3 class="font-bold text-gray-800 text-sm">${job.detail}</h3>
                            
                            <div class="mt-2 bg-gray-50 p-2 rounded-lg border border-dashed text-center">
                                <span class="text-gray-400 text-[10px]">‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:</span>
                                <span class="text-xs text-gray-700 font-bold">${job.name}</span>
                            </div>
                            
                            <div class="mt-4 flex gap-2">
                                <a href="https://maps.google.com/?q=${job.lat},${job.lng}" target="_blank" class="w-12 bg-blue-50 text-blue-600 border border-blue-200 text-center py-2 rounded-lg text-sm font-bold flex items-center justify-center hover:bg-blue-100 shadow-sm">
                                    <i class="fas fa-map-marker-alt"></i>
                                </a>
                                
                                <a href="tel:${job.phone}" class="flex-1 bg-green-50 text-green-700 border border-green-200 py-2 rounded-lg text-sm font-bold flex items-center justify-center hover:bg-green-100 shadow-sm">
                                    <i class="fas fa-phone-alt mr-2"></i> ${job.phone}
                                </a>

                                <button onclick="updateJob('${job.jobId}')" class="w-12 bg-blue-600 text-white py-2 rounded-lg text-sm font-bold shadow-md hover:bg-blue-700 transition flex items-center justify-center">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    jobList.innerHTML += card;
                });
            } catch (e) {
                document.getElementById('jobList').innerHTML = "<p class='text-center text-red-500'>‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ</p>";
            }
        }

        function viewImage(url) {
            Swal.fire({ imageUrl: url, imageWidth: '100%', showConfirmButton: false, showCloseButton: true });
        }

        async function updateJob(jobId) {
            // 1. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≤‡∏á
            let userOptions = '<option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà...</option>';
            try {
                const res = await fetch(WEB_APP_URL + "?action=getUsers");
                const users = await res.json();
                users.forEach(u => userOptions += `<option value="${u}">${u}</option>`);
            } catch (e) { userOptions = '<option value="">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>'; }

            // 2. ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            let statusOptions = '';
            try {
                const res = await fetch(WEB_APP_URL + "?action=getStatuses");
                const statuses = await res.json();
                if(statuses.length > 0){
                    statuses.forEach(s => statusOptions += `<option value="${s.name}">${s.name}</option>`);
                } else {
                    statusOptions = `<option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option><option value="‡∏£‡∏≠‡∏ß‡∏±‡∏™‡∏î‡∏∏/‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà">‡∏£‡∏≠‡∏ß‡∏±‡∏™‡∏î‡∏∏/‡∏≠‡∏∞‡πÑ‡∏´‡∏•‡πà</option>`;
                }
            } catch (e) { statusOptions = `<option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>`; }

            // 3. ‡πÅ‡∏™‡∏î‡∏á Popup
            const { value: formValues } = await Swal.fire({
                title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô',
                html:
                    '<div class="text-left text-sm text-gray-600 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</div>' +
                    `<select id="jobStatus" class="swal2-input mb-3" style="width: 80%;">${statusOptions}</select>` + 
                    
                    '<div class="text-left text-sm text-gray-600 mb-1">‡∏ú‡∏π‡πâ‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô:</div>' +
                    `<select id="staffName" class="swal2-input mb-3" style="width: 80%;">${userOptions}</select>` +
                    
                    '<div class="text-left text-sm text-gray-600 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:</div>' +
                    '<input type="password" id="staffPass" class="swal2-input" placeholder="****" style="width: 80%;">' +
                    
                    '<div class="text-left text-sm text-gray-600 mt-4 mb-1">‡∏£‡∏π‡∏õ‡∏ú‡∏•‡∏á‡∏≤‡∏ô:</div>' +
                    '<input type="file" id="imgAfter" accept="image/*" class="swal2-file" style="width: 80%;">',
                showCancelButton: true,
                confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                confirmButtonColor: '#2563eb',
                preConfirm: () => {
                    const st = document.getElementById('staffName').value;
                    const pw = document.getElementById('staffPass').value;
                    const fi = document.getElementById('imgAfter').files[0];
                    const js = document.getElementById('jobStatus').value;
                    
                    if (!st || !pw || !fi) { Swal.showValidationMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return false; }
                    return { staff: st, pass: pw, file: fi, status: js };
                }
            });

            if (formValues) {
                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                try {
                    let reader = new FileReader();
                    reader.readAsDataURL(formValues.file);
                    reader.onload = async () => {
                        let base64 = reader.result.split(',')[1];
                        let formData = new FormData();
                        formData.append("image", base64);
                        
                        let imgRes = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
                        let imgJson = await imgRes.json();
                        
                        let payload = {
                            action: "update_job",
                            jobId: jobId,
                            staff: formValues.staff,
                            password: formValues.pass,
                            image: imgJson.data.url,
                            status: formValues.status
                        };

                        await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                        setTimeout(() => {
                            Swal.fire('‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß', 'success').then(() => loadJobs());
                        }, 2500);
                    };
                } catch (e) { Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error'); }
            }
        }

        loadJobs();
    </script>
</body>
</html>


