<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ - Smart ‡∏≠‡∏ö‡∏ï.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen pb-10">

    <div class="bg-blue-600 p-6 text-white text-center shadow-lg rounded-b-3xl mb-6">
        <h1 class="text-xl font-bold">üìã ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
        <p class="text-sm opacity-80" id="profileName">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>

    <div id="historyList" class="px-4 space-y-4">
        <div class="text-center mt-10">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mx-auto"></div>
            <p class="text-gray-500 mt-2 text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì...</p>
        </div>
    </div>

    <script>
        // ---------------------------------------------------------------
        // ‚ö†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç 2 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö
        // ---------------------------------------------------------------
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxQISegHwXkwqKB73O7oDxiKf5e4u3o-m8ufB3AdQEqcC66oycFNIm7fwjzrNb3qKc4xw/exec"; // üëà ‡πÉ‡∏™‡πà URL ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy
        const LIFF_ID = "2008914907-JrrwTVWM"; // üëà ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á LIFF ID ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÇ‡∏î‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏
        // ---------------------------------------------------------------

        async function initLIFF() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    const profile = await liff.getProfile();
                    document.getElementById('profileName').innerText = "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: " + profile.displayName;
                    // ‡∏™‡πà‡∏á User ID ‡πÑ‡∏õ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    loadHistory(profile.userId);
                }
            } catch (err) {
                document.getElementById('historyList').innerHTML = `<div class="text-center text-red-500 p-10">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ LINE (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö LIFF ID)<br><span class="text-xs">${err}</span></div>`;
            }
        }

        async function loadHistory(userId) {
            try {
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Apps Script ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á action=getHistory ‡πÅ‡∏•‡∏∞ user=...
                const response = await fetch(`${WEB_APP_URL}?action=getHistory&user=${userId}`);
                const data = await response.json();
                
                const list = document.getElementById('historyList');
                list.innerHTML = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠

                if (data.length === 0) {
                    list.innerHTML = `
                        <div class="text-center text-gray-400 mt-10 flex flex-col items-center">
                            <span class="text-5xl mb-2">üì≠</span>
                            <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏</p>
                            <p class="text-xs">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏à‡πâ‡∏á‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡∏ö</p>
                        </div>`;
                    return;
                }

                data.forEach(item => {
                    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                    let statusBadge = item.status === "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" 
                        ? `<span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full font-bold">‚úÖ ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</span>`
                        : `<span class="bg-yellow-100 text-yellow-700 text-xs px-2 py-1 rounded-full font-bold">‚è≥ ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>`;
                    
                    let imageShow = item.status === "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô" && item.imageAfter 
                        ? item.imageAfter  // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°
                        : item.image;      // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á

                    let card = `
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex gap-4">
                            <img src="${imageShow}" class="w-20 h-20 object-cover rounded-lg bg-gray-200 flex-shrink-0">
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start mb-1">
                                    <h3 class="font-bold text-gray-800 text-sm truncate">${item.type}</h3>
                                    <span class="text-[10px] text-gray-400">${new Date(item.timestamp).toLocaleDateString('th-TH')}</span>
                                </div>
                                <p class="text-xs text-gray-500 line-clamp-2 mb-2">${item.detail}</p>
                                ${statusBadge}
                            </div>
                        </div>
                    `;
                    list.innerHTML += card;
                });

            } catch (e) {
                document.getElementById('historyList').innerHTML = `<div class="text-center text-red-500 p-10">‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à<br>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL Web App</div>`;
            }
        }

        initLIFF();
    </script>
</body>
</html>
