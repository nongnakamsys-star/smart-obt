<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏£‡πâ‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏Ç‡πå ‡∏≠‡∏ö‡∏ï.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        .loading { display: none; }
    </style>
</head>
<body class="max-w-md mx-auto bg-white min-h-screen shadow-lg">

    <div class="bg-blue-600 p-5 text-white text-center rounded-b-3xl shadow-md">
        <h1 class="text-2xl font-bold">üì¢ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏£‡πâ‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏Ç‡πå</h1>
        <p class="text-sm opacity-80">‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≥‡∏ö‡∏• (Smart OBT)</p>
    </div>

    <div class="p-6 space-y-4">
        
        <div class="text-center">
            <label for="fileInput" class="block w-full h-48 border-2 border-dashed border-gray-300 rounded-lg flex flex-col justify-center items-center cursor-pointer bg-gray-50 hover:bg-gray-100 relative overflow-hidden">
                <div id="previewContainer" class="absolute inset-0 flex items-center justify-center hidden">
                    <img id="previewImage" class="object-cover w-full h-full">
                </div>
                <div id="uploadPlaceholder" class="text-gray-400">
                    <svg class="mx-auto h-12 w-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <p class="mt-1 text-sm">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏</p>
                </div>
                <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="previewFile()">
            </label>
        </div>

        <div>
            <button type="button" onclick="getLocation()" class="w-full bg-orange-500 text-white py-2 rounded-lg shadow hover:bg-orange-600 flex justify-center items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            </button>
            <p id="locationStatus" class="text-xs text-center text-gray-500 mt-1">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î</p>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <input type="text" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á" class="p-3 border rounded-lg bg-gray-50 w-full">
            <input type="tel" id="phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" class="p-3 border rounded-lg bg-gray-50 w-full">
        </div>

        <select id="type" class="w-full p-3 border rounded-lg bg-white">
            <option value="" disabled selected>üîª ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏ (‡∏Ñ‡∏•‡∏¥‡∏Å)</option>
            <option value="‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞‡∏î‡∏±‡∏ö">üí° ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞‡∏î‡∏±‡∏ö</option>
            <option value="‡∏ó‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏õ‡∏≤‡πÅ‡∏ï‡∏Å/‡∏£‡∏±‡πà‡∏ß">üíß ‡∏ó‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏õ‡∏≤‡πÅ‡∏ï‡∏Å/‡∏£‡∏±‡πà‡∏ß</option>
            <option value="‡∏ñ‡∏ô‡∏ô‡∏ä‡∏≥‡∏£‡∏∏‡∏î/‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏∏‡∏°">üõ£Ô∏è ‡∏ñ‡∏ô‡∏ô‡∏ä‡∏≥‡∏£‡∏∏‡∏î/‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏∏‡∏°</option>
            <option value="‡∏Ç‡∏¢‡∏∞‡∏ï‡∏Å‡∏Ñ‡πâ‡∏≤‡∏á">üóëÔ∏è ‡∏Ç‡∏¢‡∏∞‡∏ï‡∏Å‡∏Ñ‡πâ‡∏≤‡∏á</option>
            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">üì£ ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
        </select>

        <textarea id="detail" rows="3" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏£‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà...)" class="w-full p-3 border rounded-lg bg-gray-50"></textarea>

        <button onclick="submitForm()" id="submitBtn" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition">
            ‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏ üöÄ
        </button>

    </div>

    <script>
        // =========================================================
        // ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö (‡πÅ‡∏Å‡πâ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ!)
        // =========================================================
        
        // 1. ‡πÄ‡∏≠‡∏≤ Web App URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Apps Script ‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxkMNru9GeCqmEwIdZLuSdaPAmlRkZYsC3pK8O_8ijGZFmvSFMpvnIKWbFvN9lmflha0g/exec"; 

        // 2. ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡∏≤ LIFF ID ‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ß‡πâ‡∏ô‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà 165... ‡πÑ‡∏ß‡πâ‡∏°‡∏±‡πà‡∏ß‡πÜ ‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ)
        const LIFF_ID = "2008912061-0y709pTb";

        // =========================================================

        let userProfile = {};
        let lat = "", lng = "";
        let base64Image = "";

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏ß‡πá‡∏ö
        async function main() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (liff.isLoggedIn()) {
                    userProfile = await liff.getProfile();
                    document.getElementById('name').value = userProfile.displayName; // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏•‡∏ô‡πå‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                } else {
                    liff.login();
                }
            } catch (e) {
                console.log("LIFF Error:", e);
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ó‡∏™‡∏ï‡πå‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏° ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà User ‡∏õ‡∏•‡∏≠‡∏°‡πÜ ‡πÑ‡∏ß‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö
                userProfile = { userId: "U_TEST_BROWSER", displayName: "Test User" };
            }
        }
        main();

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á GPS
        function getLocation() {
            document.getElementById('locationStatus').innerText = "üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...";
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    lat = position.coords.latitude;
                    lng = position.coords.longitude;
                    document.getElementById('locationStatus').innerText = "‚úÖ ‡πÑ‡∏î‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß: " + lat.toFixed(4) + ", " + lng.toFixed(4);
                    document.getElementById('locationStatus').classList.add("text-green-600");
                }, () => {
                    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï' ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á");
                    document.getElementById('locationStatus').innerText = "‚ùå ‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß";
                });
            } else {
                alert("‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS");
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡∏∞‡∏¢‡πà‡∏≠‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
        function previewFile() {
            const file = document.getElementById('fileInput').files[0];
            const reader = new FileReader();
            reader.onloadend = function() {
                const img = new Image();
                img.src = reader.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 800; // ‡∏¢‡πà‡∏≠‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏ô 800px
                    const scaleSize = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scaleSize;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    base64Image = canvas.toDataURL('image/jpeg', 0.7); // ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û 70%
                    
                    // ‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏π‡∏õ
                    document.getElementById('previewImage').src = base64Image;
                    document.getElementById('previewContainer').classList.remove('hidden');
                    document.getElementById('uploadPlaceholder').classList.add('hidden');
                }
            }
            if (file) reader.readAsDataURL(file);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        function submitForm() {
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const type = document.getElementById('type').value;
            const detail = document.getElementById('detail').value;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            if (!type || !detail) {
                Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î', 'warning');
                return;
            }
            if (!lat) {
                Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö', 'warning');
                return;
            }

            // ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î
            const btn = document.getElementById('submitBtn');
            btn.innerHTML = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
            btn.disabled = true;

            // ‡πÅ‡∏û‡πá‡∏Ñ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡πà‡∏á
            const payload = {
                action: "new_report",
                user: userProfile.userId || "U_UNKNOWN",
                name: name,
                phone: phone,
                type: type,
                detail: detail,
                lat: lat,
                lng: lng,
                image: base64Image,
                replyToken: "" // ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö LIFF ‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏Å‡πá‡πÑ‡∏î‡πâ
            };

            // ‡∏¢‡∏¥‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ü‡πâ‡∏≤‡πÑ‡∏õ‡∏´‡∏≤ Apps Script
            fetch(WEB_APP_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô: ' + data.jobId, 'success')
                .then(() => {
                    liff.closeWindow(); // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÑ‡∏•‡∏ô‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                });
            })
            .catch(error => {
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error');
                console.error(error);
                btn.innerHTML = "‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏ üöÄ";
                btn.disabled = false;
            });
        }
    </script>
</body>

</html>

