<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>р╣Бр╕Ир╣Йр╕Зр╣Ар╕лр╕Хр╕╕ р╕нр╕Ър╕Х. V3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
    </style>
</head>
<body class="max-w-md mx-auto bg-white min-h-screen shadow-lg">

    <div class="bg-blue-600 p-5 text-white text-center rounded-b-3xl shadow-md">
        <h1 class="text-2xl font-bold">ЁЯУв р╣Бр╕Ир╣Йр╕Зр╣Ар╕лр╕Хр╕╕р╕гр╣Йр╕нр╕Зр╕Чр╕╕р╕Бр╕Вр╣М</h1>
        <p class="text-sm opacity-80">р╕нр╕Зр╕Др╣Мр╕Бр╕▓р╕гр╕Ър╕гр╕┤р╕лр╕▓р╕гр╕кр╣Ир╕зр╕Щр╕Хр╕│р╕Ър╕е (Smart OBT)</p>
    </div>

    <div class="p-6 space-y-4">
        <div class="text-center">
            <label for="fileInput" class="block w-full h-48 border-2 border-dashed border-gray-300 rounded-lg flex flex-col justify-center items-center cursor-pointer bg-gray-50 relative overflow-hidden">
                <div id="previewContainer" class="absolute inset-0 flex items-center justify-center hidden">
                    <img id="previewImage" class="object-cover w-full h-full">
                </div>
                <div id="uploadPlaceholder" class="text-gray-400 text-center">
                    <p class="text-4xl">ЁЯУ╕</p>
                    <p class="mt-1 text-sm">р╣Бр╕Хр╕░р╣Ар╕Юр╕╖р╣Ир╕нр╕Цр╣Ир╕▓р╕вр╕гр╕╣р╕Ы</p>
                </div>
                <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="processImage()">
            </label>
        </div>

        <button type="button" onclick="getLocation()" class="w-full bg-orange-500 text-white py-2 rounded-lg shadow font-bold">ЁЯУН р╕гр╕░р╕Ър╕╕р╕Хр╕│р╣Бр╕лр╕Щр╣Ир╕Зр╕Юр╕┤р╕Бр╕▒р╕Ф</button>
        <p id="locationStatus" class="text-xs text-center text-gray-500">р╕вр╕▒р╕Зр╣Др╕бр╣Ир╣Др╕Фр╣Йр╕гр╕░р╕Ър╕╕р╕Юр╕┤р╕Бр╕▒р╕Ф</p>

        <div class="grid grid-cols-2 gap-3">
            <input type="text" id="name" placeholder="р╕Кр╕╖р╣Ир╕нр╕Ьр╕╣р╣Йр╣Бр╕Ир╣Йр╕З" class="p-3 border rounded-lg bg-gray-50">
            <input type="tel" id="phone" placeholder="р╣Ар╕Ър╕нр╕гр╣Мр╣Вр╕Чр╕г" class="p-3 border rounded-lg bg-gray-50">
        </div>

        <select id="type" class="w-full p-3 border rounded-lg bg-white">
            <option value="" disabled selected>ЁЯФ╗ р╣Ар╕ер╕╖р╕нр╕Бр╕Ыр╕гр╕░р╣Ар╕ар╕Чр╣Ар╕лр╕Хр╕╕</option>
            <option value="р╣Др╕Яр╕Яр╣Йр╕▓р╕кр╕▓р╕Шр╕▓р╕гр╕Ур╕░р╕Фр╕▒р╕Ъ">ЁЯТб р╣Др╕Яр╕Яр╣Йр╕▓р╕кр╕▓р╕Шр╕▓р╕гр╕Ур╕░р╕Фр╕▒р╕Ъ</option>
            <option value="р╕Чр╣Ир╕нр╕Ыр╕гр╕░р╕Ыр╕▓р╣Бр╕Хр╕Б/р╕гр╕▒р╣Ир╕з">ЁЯТз р╕Чр╣Ир╕нр╕Ыр╕гр╕░р╕Ыр╕▓р╣Бр╕Хр╕Б/р╕гр╕▒р╣Ир╕з</option>
            <option value="р╕Цр╕Щр╕Щр╕Кр╕│р╕гр╕╕р╕Ф/р╣Ар╕Ыр╣Зр╕Щр╕лр╕ер╕╕р╕б">ЁЯЫгя╕П р╕Цр╕Щр╕Щр╕Кр╕│р╕гр╕╕р╕Ф/р╣Ар╕Ыр╣Зр╕Щр╕лр╕ер╕╕р╕б</option>
            <option value="р╕Вр╕вр╕░р╕Хр╕Бр╕Др╣Йр╕▓р╕З">ЁЯЧСя╕П р╕Вр╕вр╕░р╕Хр╕Бр╕Др╣Йр╕▓р╕З</option>
            <option value="р╕нр╕╖р╣Ир╕Щр╣Ж">ЁЯУг р╕нр╕╖р╣Ир╕Щр╣Ж</option>
        </select>

        <textarea id="detail" rows="3" placeholder="р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Фр╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Хр╕┤р╕б..." class="w-full p-3 border rounded-lg bg-gray-50"></textarea>

        <button onclick="submitForm()" id="submitBtn" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 disabled:bg-gray-400">
            р╕кр╣Ир╕Зр╣Ар╕гр╕╖р╣Ир╕нр╕Зр╣Бр╕Ир╣Йр╕Зр╣Ар╕лр╕Хр╕╕ ЁЯЪА
        </button>
    </div>

    <script>
        // --- р╕кр╣Ир╕зр╕Щр╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ ---
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwOtFnwBGger3xYTwMO-KPzswCMwLLq9unBU6vVwXdH-kUE4iQXQ4vjRg4KFobXFaa-ZA/exec"; 
        const LIFF_ID = "2008912061-0y709pTb";
        // ----------------

        let base64Image = "";
        let lat = "", lng = "";

        async function initLIFF() {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); }
            else {
                const profile = await liff.getProfile();
                document.getElementById('name').value = profile.displayName;
            }
        }
        initLIFF();

        function processImage() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return;

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerText = "тП│ р╕Бр╕│р╕ер╕▒р╕Зр╣Вр╕лр╕ер╕Фр╕гр╕╣р╕Ы...";

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const maxWidth = 800;
                    const scaleSize = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕гр╕╣р╕Ыр╣Гр╕кр╣Ир╕Хр╕▒р╕зр╣Бр╕Ыр╕г
                    base64Image = canvas.toDataURL('image/jpeg', 0.8);
                    
                    document.getElementById('previewImage').src = base64Image;
                    document.getElementById('previewContainer').classList.remove('hidden');
                    document.getElementById('uploadPlaceholder').classList.add('hidden');
                    
                    btn.disabled = false;
                    btn.innerText = "р╕кр╣Ир╕Зр╣Ар╕гр╕╖р╣Ир╕нр╕Зр╣Бр╕Ир╣Йр╕Зр╣Ар╕лр╕Хр╕╕ ЁЯЪА";
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    lat = pos.coords.latitude; lng = pos.coords.longitude;
                    document.getElementById('locationStatus').innerText = "тЬЕ р╣Др╕Фр╣Йр╕Юр╕┤р╕Бр╕▒р╕Фр╣Бр╕ер╣Йр╕з: " + lat.toFixed(4) + ", " + lng.toFixed(4);
                });
            }
        }

        function submitForm() {
            alert("р╕Вр╕Щр╕▓р╕Фр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕Чр╕╡р╣Ир╕Бр╕│р╕ер╕▒р╕Зр╕Ир╕░р╕кр╣Ир╕Зр╕Др╕╖р╕н: " + base64Image.length);
            const type = document.getElementById('type').value;
            const detail = document.getElementById('detail').value;

            if (!base64Image) {
                Swal.fire('р╕Вр╕нр╕нр╕ар╕▒р╕в', 'р╕Бр╕гр╕╕р╕Ур╕▓р╕Цр╣Ир╕▓р╕вр╕гр╕╣р╕Ыр╕ар╕▓р╕Юр╕Ыр╕гр╕░р╕Бр╕нр╕Ър╕Фр╣Йр╕зр╕вр╕Др╕гр╕▒р╕Ъ', 'warning');
                return;
            }
            if (!lat) {
                Swal.fire('р╕Вр╕нр╕нр╕ар╕▒р╕в', 'р╕Бр╕гр╕╕р╕Ур╕▓р╕Бр╕Фр╕гр╕░р╕Ър╕╕р╕Хр╕│р╣Бр╕лр╕Щр╣Ир╕Зр╕Бр╣Ир╕нр╕Щр╕Др╕гр╕▒р╕Ъ', 'warning');
                return;
            }

            Swal.fire({ title: 'р╕Бр╕│р╕ер╕▒р╕Зр╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
            alert("р╕Вр╕Щр╕▓р╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕гр╕╣р╕Ыр╕ар╕▓р╕Ю: " + base64Image.length + " р╕Хр╕▒р╕зр╕нр╕▒р╕Бр╕йр╕г");
            const payload = {
                action: "new_report",
                user: liff.getContext()?.userId || "Unknown",
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                type: type,
                detail: detail,
                lat: lat,
                lng: lng,
                image: base64Image
            };

            fetch(WEB_APP_URL, {
                method: 'POST',
                // ЁЯЪй р╕лр╣Йр╕▓р╕бр╣Гр╕кр╣И no-cors р╕Щр╕░р╕Др╕гр╕▒р╕Ъ
                body: JSON.stringify(payload) 
            }).then(res => {
                // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕кр╣Ир╕Зр╕кр╕│р╣Ар╕гр╣Зр╕Ир╣Др╕лр╕б
                if(res.ok) {
                    Swal.fire('р╕кр╕│р╣Ар╕гр╣Зр╕И!', 'р╕кр╣Ир╕Зр╣Бр╕Ир╣Йр╕Зр╣Ар╕лр╕Хр╕╕р╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕вр╣Бр╕ер╣Йр╕з', 'success').then(() => {
                        liff.closeWindow();
                    });
                }
            }).catch(err => {
                Swal.fire('р╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф', 'р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕бр╣Ир╕кр╕│р╣Ар╕гр╣Зр╕И', 'error');
            });
        }
    </script>
</body>
</html>



