<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart ‡∏≠‡∏ö‡∏ï.‡∏´‡∏ô‡∏≠‡∏á‡∏ô‡∏≤‡∏Ñ‡∏≥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà */
        #map { 
            height: 300px; 
            width: 100%; 
            border-radius: 12px; 
            z-index: 0; 
        }
    </style>
</head>
<body class="max-w-md mx-auto bg-gray-100 min-h-screen pb-10">
    
    <div class="bg-blue-600 p-6 text-white text-center rounded-b-3xl shadow-lg">
        <h1 class="text-2xl font-bold">üì¢ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
        <p class="text-sm opacity-80">‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≥‡∏ö‡∏•‡∏´‡∏ô‡∏≠‡∏á‡∏ô‡∏≤‡∏Ñ‡∏≥</p>
    </div>

    <div class="p-6 space-y-4">
        
        <div class="text-center">
            <label for="fileInput" class="block w-full h-48 border-2 border-dashed border-gray-300 rounded-xl flex flex-col justify-center items-center cursor-pointer bg-white relative overflow-hidden hover:bg-gray-50 transition">
                <div id="previewContainer" class="absolute inset-0 hidden"><img id="previewImage" class="object-cover w-full h-full"></div>
                <div id="uploadPlaceholder" class="text-gray-400">
                    <p class="text-4xl mb-2">üì∏</p>
                    <p class="text-sm">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô</p>
                </div>
                <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="processImage()">
            </label>
        </div>

        <div class="bg-white p-3 rounded-xl shadow-sm border">
            <div class="flex justify-between items-center mb-2">
                <label class="block text-sm font-bold text-gray-700">üìç ‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î</label>
                <button onclick="findMyLocation()" class="bg-green-500 text-white text-xs px-3 py-2 rounded-lg shadow hover:bg-green-600 transition flex items-center gap-1">
                    üéØ‡∏Å‡∏î‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                </button>
            </div>
            
            <div id="map"></div>
            <p class="text-xs text-red-500 mt-2 text-center">* ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏∏‡∏î‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏à‡∏∏‡∏î‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏</p>
        </div>

        <div class="space-y-3">
            <input type="text" id="name" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500 shadow-sm">
            <input type="tel" id="phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö" class="w-full p-3 border rounded-lg shadow-sm">
            
            <select id="type" class="w-full p-3 border rounded-lg bg-white shadow-sm">
                <option value="" disabled selected>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏...</option>
            </select>
            
            <textarea id="detail" rows="3" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..." class="w-full p-3 border rounded-lg shadow-sm"></textarea>
        </div>

        <button onclick="submitForm()" id="submitBtn" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition-transform hover:bg-blue-700">üöÄ ‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ---
       // const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyR5AbSBwEoKOWDm6IENPWtNCwqOBB9BRbv46QJBWjJJhAQ_U3qNGiTZK04zdfw6jbuEg/exec"; 
       const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxQISegHwXkwqKB73O7oDxiKf5e4u3o-m8ufB3AdQEqcC66oycFNIm7fwjzrNb3qKc4xw/exec";
        const LIFF_ID = "2008912061-0y709pTb";
        const IMGBB_API_KEY = "2a80595118a7dc36b3ebda7a006fef3b";
        // -------------------------

        let base64Image = "";
        let lat = "", lng = "";
        let lineUserId = "";
        let map, marker; 

        window.onload = async function() {
            await initLIFF();
            initMap(); 
        };

        async function initLIFF() {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); }
            else {
                const profile = await liff.getProfile();
                lineUserId = profile.userId;
                loadCategories();
            }
        }

        // üó∫Ô∏è ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
        function initMap() {
            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡∏≠‡∏ö‡∏ï.‡∏´‡∏ô‡∏≠‡∏á‡∏ô‡∏≤‡∏Ñ‡∏≥ (‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á‡πÜ)
            map = L.map('map').setView([17.06, 102.55], 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            marker = L.marker([17.06, 102.55], { draggable: true }).addTo(map);

            marker.on('dragend', function(e) {
                var coord = e.target.getLatLng();
                lat = coord.lat;
                lng = coord.lng;
            });

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏´‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            findMyLocation();
        }

        // üéØ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ)
        function findMyLocation() {
            if (navigator.geolocation) {
                // ‡πÅ‡∏™‡∏î‡∏á Loading ‡πÄ‡∏•‡πá‡∏Å‡πÜ (Optional: ‡πÉ‡∏ä‡πâ SweetAlert ‡πÅ‡∏ö‡∏ö Toast ‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÄ‡∏≠‡∏≤‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡πÜ ‡∏Å‡πà‡∏≠‡∏ô)
                // navigator.geolocation.getCurrentPosition(success, error, options)
                navigator.geolocation.getCurrentPosition(function(position) {
                    lat = position.coords.latitude;
                    lng = position.coords.longitude;
                    
                    // ‡∏¢‡πâ‡∏≤‡∏¢‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏∏‡∏î
                    map.setView([lat, lng], 18); // Zoom ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏Å‡∏•‡πâ‡πÜ (‡∏£‡∏∞‡∏î‡∏±‡∏ö 18)
                    marker.setLatLng([lat, lng]);
                    
                    Swal.fire({
                        icon: 'success',
                        title: '‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢',
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 1500
                    });

                }, function() {
                    Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS ‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î GPS ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏≠‡∏á', 'warning');
                }, { enableHighAccuracy: true }); // ‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏™‡∏π‡∏á
            } else {
                alert("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS");
            }
        }

        async function loadCategories() {
            try {
                const response = await fetch(WEB_APP_URL + "?action=getCategories");
                const categories = await response.json();
                const select = document.getElementById('type');
                
                select.innerHTML = '<option value="" disabled selected>üîª ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏</option>';
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    select.appendChild(option);
                });
            } catch (error) {
                document.getElementById('type').innerHTML = '<option value="" disabled selected>‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>';
            }
        }

        function processImage() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                base64Image = e.target.result.split(',')[1];
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('previewContainer').classList.remove('hidden');
                document.getElementById('uploadPlaceholder').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        async function submitForm() {
            const name = document.getElementById('name').value;
            const type = document.getElementById('type').value;

            if (!name || !base64Image || !lat || !type) { 
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ ‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏‡∏Ñ‡∏£‡∏±‡∏ö', 'warning'); 
                return; 
            }
            
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

            try {
                let formData = new FormData();
                formData.append("image", base64Image);
                let imgRes = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
                let imgJson = await imgRes.json();
                let finalImg = imgJson.data.url;

                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

                let payload = {
                    action: "new_report",
                    user: lineUserId,
                    name: name,
                    phone: document.getElementById('phone').value,
                    type: type,
                    detail: document.getElementById('detail').value,
                    lat: lat, 
                    lng: lng,
                    image: finalImg
                };

                await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success').then(() => liff.closeWindow());
            } catch (e) { Swal.fire('‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error'); }
        }
    </script>
</body>
</html>







