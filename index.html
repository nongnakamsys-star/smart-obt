<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart ‡∏≠‡∏ö‡∏ï.‡∏´‡∏ô‡∏≠‡∏á‡∏ô‡∏≤‡∏Ñ‡∏≥</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body class="max-w-md mx-auto bg-gray-100 min-h-screen">
    <div class="bg-blue-600 p-6 text-white text-center rounded-b-3xl shadow-lg">
        <h1 class="text-2xl font-bold">üì¢ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</h1>
        <p class="text-sm opacity-80">‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≥‡∏ö‡∏•‡∏´‡∏ô‡∏≠‡∏á‡∏ô‡∏≤‡∏Ñ‡∏≥</p>
    </div>

    <div class="p-6 space-y-4">
        <div class="text-center">
            <label for="fileInput" class="block w-full h-48 border-2 border-dashed border-gray-300 rounded-xl flex flex-col justify-center items-center cursor-pointer bg-white relative overflow-hidden">
                <div id="previewContainer" class="absolute inset-0 hidden"><img id="previewImage" class="object-cover w-full h-full"></div>
                <div id="uploadPlaceholder" class="text-gray-400">
                    <p class="text-4xl">üì∏</p><p class="text-sm">‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà(‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô)</p>
                </div>
                <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="processImage()">
            </label>
        </div>

        <button onclick="getLocation()" class="w-full bg-orange-500 text-white py-3 rounded-xl font-bold shadow">üìç‡∏Å‡∏î‡∏õ‡∏∏‡∏°‡∏™‡πà‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î</button>
        <p id="locationStatus" class="text-xs text-center text-gray-500 italic">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î</p>

        <div class="space-y-3">
            <input type="text" id="name" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á" class="w-full p-3 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500">
            <input type="tel" id="phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠" class="w-full p-3 border rounded-lg">
            
            <select id="type" class="w-full p-3 border rounded-lg bg-white">
                <option value="" disabled selected>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏...</option>
            </select>
            
            <textarea id="detail" rows="3" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î..." class="w-full p-3 border rounded-lg"></textarea>
        </div>

        <button onclick="submitForm()" id="submitBtn" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg active:scale-95 transition-transform">üöÄ ‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏</button>
    </div>

    <script>
        // --- ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ---
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxqeAYfMnR5L71zChnTH9fuhYL_GQZM8AfXCuSe0opauOgeZ9-1bUBlnT6OE21HD5DH8g/exec"; 
        const LIFF_ID = "2008912061-0y709pTb";
        const IMGBB_API_KEY = "2a80595118a7dc36b3ebda7a006fef3b";
        // -------------------------

        let base64Image = "";
        let lat = "", lng = "";
        let lineUserId = ""; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö User ID

        async function initLIFF() {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); }
            else {
                const profile = await liff.getProfile();
                lineUserId = profile.userId; // üö© ‡πÄ‡∏Å‡πá‡∏ö LINE User ID ‡πÑ‡∏ß‡πâ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ Google Sheet
                // üö© ‡∏•‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á displayName ‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡πà‡∏≤‡∏á
                loadCategories();
            }
        }
        initLIFF();

        async function loadCategories() {
            try {
                const response = await fetch(WEB_APP_URL + "?action=getCategories");
                const categories = await response.json();
                const select = document.getElementById('type');
                
                select.innerHTML = '<option value="" disabled selected>üîª ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏</option>';
                
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = cat;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error("Load failed:", error);
                document.getElementById('type').innerHTML = '<option value="" disabled selected>‚ùå ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>';
            }
        }

        function processImage() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                base64Image = e.target.result.split(',')[1];
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('previewContainer').classList.remove('hidden');
                document.getElementById('uploadPlaceholder').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        function getLocation() {
            navigator.geolocation.getCurrentPosition((pos) => {
                lat = pos.coords.latitude; lng = pos.coords.longitude;
                document.getElementById('locationStatus').innerText = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
            });
        }

        async function submitForm() {
            const name = document.getElementById('name').value; // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á
            const type = document.getElementById('type').value;

            // üö© ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (!name || !base64Image || !lat || !type) { 
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ ‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏‡∏Ñ‡∏£‡∏±‡∏ö', 'warning'); 
                return; 
            }
            
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

            try {
                let formData = new FormData();
                formData.append("image", base64Image);
                let imgRes = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
                let imgJson = await imgRes.json();
                let finalImg = imgJson.data.url;

                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

                let payload = {
                    action: "new_report",
                    user: lineUserId, // üö© ‡∏™‡πà‡∏á LINE User ID ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                    name: name,       // üö© ‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á
                    phone: document.getElementById('phone').value,
                    type: type,
                    detail: document.getElementById('detail').value,
                    lat: lat, lng: lng, image: finalImg
                };

                await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success').then(() => liff.closeWindow());
            } catch (e) { Swal.fire('‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà', 'error'); }
        }
    </script>
</body>
</html>

