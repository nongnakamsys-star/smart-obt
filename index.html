<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แจ้งเหตุ อบต. V3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
    </style>
</head>
<body class="max-w-md mx-auto bg-white min-h-screen shadow-lg">

    <div class="bg-blue-600 p-5 text-white text-center rounded-b-3xl shadow-md">
        <h1 class="text-2xl font-bold">📢 แจ้งเหตุร้องทุกข์</h1>
        <p class="text-sm opacity-80">องค์การบริหารส่วนตำบล (Smart OBT)</p>
    </div>

    <div class="p-6 space-y-4">
        <div class="text-center">
            <label for="fileInput" class="block w-full h-48 border-2 border-dashed border-gray-300 rounded-lg flex flex-col justify-center items-center cursor-pointer bg-gray-50 relative overflow-hidden">
                <div id="previewContainer" class="absolute inset-0 flex items-center justify-center hidden">
                    <img id="previewImage" class="object-cover w-full h-full">
                </div>
                <div id="uploadPlaceholder" class="text-gray-400 text-center">
                    <p class="text-4xl">📸</p>
                    <p class="mt-1 text-sm">แตะเพื่อถ่ายรูป</p>
                </div>
                <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="processImage()">
            </label>
        </div>

        <button type="button" onclick="getLocation()" class="w-full bg-orange-500 text-white py-2 rounded-lg shadow font-bold">📍 ระบุตำแหน่งพิกัด</button>
        <p id="locationStatus" class="text-xs text-center text-gray-500">ยังไม่ได้ระบุพิกัด</p>

        <div class="grid grid-cols-2 gap-3">
            <input type="text" id="name" placeholder="ชื่อผู้แจ้ง" class="p-3 border rounded-lg bg-gray-50">
            <input type="tel" id="phone" placeholder="เบอร์โทร" class="p-3 border rounded-lg bg-gray-50">
        </div>

        <select id="type" class="w-full p-3 border rounded-lg bg-white">
            <option value="" disabled selected>🔻 เลือกประเภทเหตุ</option>
            <option value="ไฟฟ้าสาธารณะดับ">💡 ไฟฟ้าสาธารณะดับ</option>
            <option value="ท่อประปาแตก/รั่ว">💧 ท่อประปาแตก/รั่ว</option>
            <option value="ถนนชำรุด/เป็นหลุม">🛣️ ถนนชำรุด/เป็นหลุม</option>
            <option value="ขยะตกค้าง">🗑️ ขยะตกค้าง</option>
            <option value="อื่นๆ">📣 อื่นๆ</option>
        </select>

        <textarea id="detail" rows="3" placeholder="รายละเอียดเพิ่มเติม..." class="w-full p-3 border rounded-lg bg-gray-50"></textarea>

        <button onclick="submitForm()" id="submitBtn" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 disabled:bg-gray-400">
            ส่งเรื่องแจ้งเหตุ 🚀
        </button>
    </div>

    <script>
        // --- ส่วนตั้งค่า ---
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbypvdpyAIRB68kvhmtVL9p7iRs7gtC1jjB_4lDSpjaRbH_FHw4avAoOKr7GXcFWnR_SZw/exec"; 
        const LIFF_ID = "2008912061-0y709pTb";
        // ----------------

        let base64Image = "";
        let lat = "", lng = "";

        async function initLIFF() {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); }
            else {
                const profile = await liff.getProfile();
                document.getElementById('name').value = profile.displayName;
            }
        }
        initLIFF();

        function processImage() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return;

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerText = "⏳ กำลังโหลดรูป...";

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const maxWidth = 800;
                    const scaleSize = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // บันทึกรูปใส่ตัวแปร
                    base64Image = canvas.toDataURL('image/jpeg', 0.8);
                    
                    document.getElementById('previewImage').src = base64Image;
                    document.getElementById('previewContainer').classList.remove('hidden');
                    document.getElementById('uploadPlaceholder').classList.add('hidden');
                    
                    btn.disabled = false;
                    btn.innerText = "ส่งเรื่องแจ้งเหตุ 🚀";
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    lat = pos.coords.latitude; lng = pos.coords.longitude;
                    document.getElementById('locationStatus').innerText = "✅ ได้พิกัดแล้ว: " + lat.toFixed(4) + ", " + lng.toFixed(4);
                });
            }
        }

        function submitForm() {
            const type = document.getElementById('type').value;
            const detail = document.getElementById('detail').value;

            if (!base64Image) {
                Swal.fire('ขออภัย', 'กรุณาถ่ายรูปภาพประกอบด้วยครับ', 'warning');
                return;
            }
            if (!lat) {
                Swal.fire('ขออภัย', 'กรุณากดระบุตำแหน่งก่อนครับ', 'warning');
                return;
            }

            Swal.fire({ title: 'กำลังส่งข้อมูล...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

            const payload = {
                action: "new_report",
                user: liff.getContext()?.userId || "Unknown",
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                type: type,
                detail: detail,
                lat: lat,
                lng: lng,
                image: base64Image
            };

            fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors', // เพิ่มเพื่อป้องกันปัญหา CORS บางกรณี
                body: JSON.stringify(payload)
            }).then(() => {
                Swal.fire('สำเร็จ!', 'ส่งแจ้งเหตุเรียบร้อยแล้ว', 'success').then(() => {
                    liff.closeWindow();
                });
            }).catch(err => {
                Swal.fire('ผิดพลาด', 'ส่งข้อมูลไม่สำเร็จ กรุณาลองใหม่', 'error');
            });
        }
    </script>
</body>
</html>
