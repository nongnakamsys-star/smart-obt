<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart ‡∏≠‡∏ö‡∏ï. V3.0 (ImgBB Mode)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap');
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
    </style>
</head>
<body class="max-w-md mx-auto bg-white min-h-screen shadow-lg">

    <div class="bg-blue-600 p-5 text-white text-center rounded-b-3xl shadow-md">
        <h1 class="text-2xl font-bold">üì¢ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏£‡πâ‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡∏Ç‡πå</h1>
        <p class="text-sm opacity-80">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡πà‡∏≤‡∏ô ImgBB</p>
    </div>

    <div class="p-6 space-y-4">
        <div class="text-center">
            <label for="fileInput" class="block w-full h-48 border-2 border-dashed border-gray-300 rounded-lg flex flex-col justify-center items-center cursor-pointer bg-gray-50 relative overflow-hidden">
                <div id="previewContainer" class="absolute inset-0 flex items-center justify-center hidden">
                    <img id="previewImage" class="object-cover w-full h-full">
                </div>
                <div id="uploadPlaceholder" class="text-gray-400 text-center">
                    <p class="text-4xl">üì∏</p>
                    <p class="mt-1 text-sm">‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</p>
                </div>
                <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="processImage()">
            </label>
        </div>

        <button type="button" onclick="getLocation()" class="w-full bg-orange-500 text-white py-2 rounded-lg shadow font-bold">üìç ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î</button>
        <p id="locationStatus" class="text-xs text-center text-gray-500 italic">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î</p>

        <div class="grid grid-cols-2 gap-3">
            <input type="text" id="name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á" class="p-3 border rounded-lg bg-gray-50">
            <input type="tel" id="phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" class="p-3 border rounded-lg bg-gray-50">
        </div>

        <select id="type" class="w-full p-3 border rounded-lg bg-white">
            <option value="" disabled selected>üîª ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏</option>
            <option value="‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞‡∏î‡∏±‡∏ö">üí° ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞‡∏î‡∏±‡∏ö</option>
            <option value="‡∏ó‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏õ‡∏≤‡πÅ‡∏ï‡∏Å/‡∏£‡∏±‡πà‡∏ß">üíß ‡∏ó‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏õ‡∏≤‡πÅ‡∏ï‡∏Å/‡∏£‡∏±‡πà‡∏ß</option>
            <option value="‡∏ñ‡∏ô‡∏ô‡∏ä‡∏≥‡∏£‡∏∏‡∏î/‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏∏‡∏°">üõ£Ô∏è ‡∏ñ‡∏ô‡∏ô‡∏ä‡∏≥‡∏£‡∏∏‡∏î/‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏∏‡∏°</option>
            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">üì£ ‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
        </select>

        <textarea id="detail" rows="3" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..." class="w-full p-3 border rounded-lg bg-gray-50"></textarea>

        <button onclick="submitForm()" id="submitBtn" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700">
            ‡∏™‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏ üöÄ
        </button>
    </div>

    <script>
        // --- ‚öôÔ∏è ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç 3 ‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ) ---
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwep5hm9DqGZdQtV7TmmGHbrJ_7A7xcn8h0RQjDvqkInFIqHryqk3mBhYWC7LGfM1IbmQ/exec"; 
        const LIFF_ID = "2008912061-0y709pTb";
        const IMGBB_API_KEY = "2a80595118a7dc36b3ebda7a006fef3b";
        // ----------------------------------

        let base64Image = "";
        let lat = "", lng = "";

        async function initLIFF() {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); }
            else {
                const profile = await liff.getProfile();
                document.getElementById('name').value = profile.displayName;
            }
        }
        initLIFF();

        function processImage() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                base64Image = e.target.result.split(',')[1]; // ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• base64 (‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤ header)
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('previewContainer').classList.remove('hidden');
                document.getElementById('uploadPlaceholder').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    lat = pos.coords.latitude; lng = pos.coords.longitude;
                    document.getElementById('locationStatus').innerText = "‚úÖ ‡πÑ‡∏î‡πâ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡πâ‡∏ß: " + lat.toFixed(4) + ", " + lng.toFixed(4);
                });
            }
        }

        async function submitForm() {
            const type = document.getElementById('type').value;
            if (!base64Image || !lat || !type) {
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ ‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏‡∏Ñ‡∏£‡∏±‡∏ö', 'warning');
                return;
            }

            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

            try {
                // 1. ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡πÑ‡∏õ ImgBB
                const formData = new FormData();
                formData.append("image", base64Image);
                const imgRes = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: "POST",
                    body: formData
                });
                const imgData = await imgRes.json();
                const finalImageUrl = imgData.data.url;

                // 2. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏õ Google Script
                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });

                const payload = {
                    action: "new_report",
                    user: liff.getContext()?.userId || "Unknown",
                    name: document.getElementById('name').value,
                    phone: document.getElementById('phone').value,
                    type: type,
                    detail: document.getElementById('detail').value,
                    lat: lat,
                    lng: lng,
                    image: finalImageUrl // ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏à‡∏≤‡∏Å ImgBB
                };

                await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(payload)
                });

                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success').then(() => liff.closeWindow());

            } catch (error) {
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error, 'error');
            }
        }
    </script>
</body>
</html>

