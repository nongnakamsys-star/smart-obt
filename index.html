<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart р╕нр╕Ър╕Х. V3.0 (ImgBB)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body class="max-w-md mx-auto bg-gray-100 min-h-screen">
    <div class="bg-blue-600 p-6 text-white text-center rounded-b-3xl shadow-lg">
        <h1 class="text-2xl font-bold">ЁЯУв р╣Бр╕Ир╣Йр╕Зр╣Ар╕лр╕Хр╕╕</h1>
        <p class="text-sm opacity-80">р╕нр╕Зр╕Др╣Мр╕Бр╕▓р╕гр╕Ър╕гр╕┤р╕лр╕▓р╕гр╕кр╣Ир╕зр╕Щр╕Хр╕│р╕Ър╕ер╕лр╕Щр╕нр╕Зр╕Щр╕▓р╕Др╕│</p>
    </div>

    <div class="p-6 space-y-4">
        <div class="text-center">
            <label for="fileInput" class="block w-full h-48 border-2 border-dashed border-gray-300 rounded-xl flex flex-col justify-center items-center cursor-pointer bg-white relative overflow-hidden">
                <div id="previewContainer" class="absolute inset-0 hidden"><img id="previewImage" class="object-cover w-full h-full"></div>
                <div id="uploadPlaceholder" class="text-gray-400">
                    <p class="text-4xl">ЁЯУ╕</p><p class="text-sm">р╕Цр╣Ир╕▓р╕вр╕гр╕╣р╕Ыр╣Бр╕Ир╣Йр╕Зр╣Ар╕лр╕Хр╕╕</p>
                </div>
                <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="processImage()">
            </label>
        </div>

        <button onclick="getLocation()" class="w-full bg-orange-500 text-white py-3 rounded-xl font-bold shadow">ЁЯУН р╕Бр╕Фр╕гр╕░р╕Ър╕╕р╕Хр╕│р╣Бр╕лр╕Щр╣Ир╕Зр╕Юр╕┤р╕Бр╕▒р╕Ф</button>
        <p id="locationStatus" class="text-xs text-center text-gray-500 italic">р╕вр╕▒р╕Зр╣Др╕бр╣Ир╣Др╕Фр╣Йр╕гр╕░р╕Ър╕╕р╕Юр╕┤р╕Бр╕▒р╕Ф</p>

        <div class="space-y-3">
            <input type="text" id="name" placeholder="р╕Кр╕╖р╣Ир╕нр╕Ьр╕╣р╣Йр╣Бр╕Ир╣Йр╕З" class="w-full p-3 border rounded-lg">
            <input type="tel" id="phone" placeholder="р╣Ар╕Ър╕нр╕гр╣Мр╣Вр╕Чр╕гр╕Хр╕┤р╕Фр╕Хр╣Ир╕н" class="w-full p-3 border rounded-lg">
            <select id="type" class="w-full p-3 border rounded-lg">
                <option value="" disabled selected>ЁЯФ╗ р╣Ар╕ер╕╖р╕нр╕Бр╕Ыр╕гр╕░р╣Ар╕ар╕Чр╣Ар╕лр╕Хр╕╕</option>
                <option value="р╣Др╕Яр╕Яр╣Йр╕▓р╕кр╕▓р╕Шр╕▓р╕гр╕Ур╕░р╕Фр╕▒р╕Ъ">ЁЯТб р╣Др╕Яр╕Яр╣Йр╕▓р╕кр╕▓р╕Шр╕▓р╕гр╕Ур╕░р╕Фр╕▒р╕Ъ</option>
                <option value="р╕Чр╣Ир╕нр╕Ыр╕гр╕░р╕Ыр╕▓р╣Бр╕Хр╕Б/р╕гр╕▒р╣Ир╕з">ЁЯТз р╕Чр╣Ир╕нр╕Ыр╕гр╕░р╕Ыр╕▓р╣Бр╕Хр╕Б/р╕гр╕▒р╣Ир╕з</option>
                <option value="р╕Цр╕Щр╕Щр╕Кр╕│р╕гр╕╕р╕Ф">ЁЯЫгя╕П р╕Цр╕Щр╕Щр╕Кр╕│р╕гр╕╕р╕Ф</option>
                <option value="р╕нр╕╖р╣Ир╕Щр╣Ж">ЁЯУг р╕нр╕╖р╣Ир╕Щр╣Ж</option>
            </select>
            <textarea id="detail" rows="3" placeholder="р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Ф..." class="w-full p-3 border rounded-lg"></textarea>
        </div>

        <button onclick="submitForm()" id="submitBtn" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg">ЁЯЪА р╕кр╣Ир╕Зр╣Ар╕гр╕╖р╣Ир╕нр╕Зр╣Бр╕Ир╣Йр╕Зр╣Ар╕лр╕Хр╕╕</button>
    </div>

    <script>
        // --- тЪЩя╕П р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ (р╕кр╕│р╕Др╕▒р╕Нр╕бр╕▓р╕Б) ---
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxqSZApn9jd3jfRRDF4QKEdkg2PSs8XdvLBtE7xN_D87QzrvO9DUqkEemXF97iwiH1naQ/exec"; 
        const LIFF_ID = "2008912061-0y709pTb";
        const IMGBB_API_KEY = "2a80595118a7dc36b3ebda7a006fef3b";
        // -------------------------

        let base64Image = "";
        let lat = "", lng = "";

        async function initLIFF() {
            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); }
            else {
                const profile = await liff.getProfile();
                document.getElementById('name').value = profile.displayName;
            }
        }
        initLIFF();

        function processImage() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                base64Image = e.target.result.split(',')[1];
                document.getElementById('previewImage').src = e.target.result;
                document.getElementById('previewContainer').classList.remove('hidden');
                document.getElementById('uploadPlaceholder').classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        function getLocation() {
            navigator.geolocation.getCurrentPosition((pos) => {
                lat = pos.coords.latitude; lng = pos.coords.longitude;
                document.getElementById('locationStatus').innerText = "тЬЕ р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Юр╕┤р╕Бр╕▒р╕Фр╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в";
            });
        }

        async function submitForm() {
            if (!base64Image || !lat) { Swal.fire('р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕бр╣Ир╕Др╕гр╕Ъ', 'р╕Бр╕гр╕╕р╕Ур╕▓р╕Цр╣Ир╕▓р╕вр╕гр╕╣р╕Ыр╣Бр╕ер╕░р╕гр╕░р╕Ър╕╕р╕Юр╕┤р╕Бр╕▒р╕Ф', 'warning'); return; }
            
            Swal.fire({ title: 'р╕Бр╕│р╕ер╕▒р╕Зр╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╕гр╕╣р╕Ы...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            try {
                // 1. р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Фр╣Др╕Ы ImgBB
                let formData = new FormData();
                formData.append("image", base64Image);
                let imgRes = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
                let imgJson = await imgRes.json();
                let finalImg = imgJson.data.url;

                // 2. р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕Ы Google Script
                Swal.fire({ title: 'р╕Бр╕│р╕ер╕▒р╕Зр╕Ър╕▒р╕Щр╕Чр╕╢р╕Б...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                let payload = {
                    action: "new_report",
                    user: liff.getContext()?.userId,
                    name: document.getElementById('name').value,
                    phone: document.getElementById('phone').value,
                    type: document.getElementById('type').value,
                    detail: document.getElementById('detail').value,
                    lat: lat, lng: lng, image: finalImg
                };

                await fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                Swal.fire('р╕кр╕│р╣Ар╕гр╣Зр╕И!', 'р╕гр╕▒р╕Ър╣Ар╕гр╕╖р╣Ир╕нр╕Зр╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕вр╣Бр╕ер╣Йр╕з', 'success').then(() => liff.closeWindow());
            } catch (e) { Swal.fire('р╕ер╣Йр╕бр╣Ар╕лр╕ер╕з', 'р╕Бр╕гр╕╕р╕Ур╕▓р╕ер╕нр╕Зр╣Гр╕лр╕бр╣И', 'error'); }
        }
    </script>
</body>
</html>

